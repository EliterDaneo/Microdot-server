<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>PROJECT MICRODOT</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    />
  </head>

  <body class="hold-transition layout-top-nav">
    <div class="wrapper">
      <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container-fluid">
          <div class="d-flex justify-content-between align-items-center w-100">
            <div class="logo_tut">
              <img
                src="/static/img/tut.png"
                style="width: 85px; height: 85px"
              />
            </div>
            <div class="text-center mx-auto">
              <h1
                class="m-0"
                style="font-family: 'Berlin Sans FB Demi'; font-size: 1.5rem"
              >
                SEKOLAH MENENGAH KEJURUAN
              </h1>
              <h3
                class="m-0"
                style="font-family: 'Bookman Old Style'; font-size: 1.4rem"
              >
                SMKS MUHAMMADIYAH 1 WONOSOBO
              </h3>
              <h5 class="m-0" style="font-family: 'Berlin Sans FB Demi'">
                <u
                  >Jl. Kh. Ahmad Dahlan No.6, Tosarirejo, Jaraksari, Kec.
                  Wonosobo, Kab Wonosobo, Jawa Tengah 56311</u
                >
              </h5>
            </div>
            <div class="logo_vedc">
              <img
                src="/static/img/vedc.png"
                style="width: 100px; height: 70px"
              />
            </div>
          </div>
        </div>
      </nav>

      <div class="container">
        <div class="col-sm-12">
          <div class="text-right">
            <marquee
              id="running-text"
              behavior="scroll"
              direction="left"
              class="text-info font-weight-bold"
              style="font-size: 2rem"
            >
              Loading running text...
            </marquee>
          </div>
        </div>
        <!-- <div class="text-center">
          <h5>SMART DASHBOARD MUTUTECH</h5>
        </div> -->
      </div>

      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <div id="ip" class="text-center">
              <h5>Loading ip address...</h5>
            </div>

            <div class="mt-1 rounded-full">
              <div class="row">
                <div class="col-lg-6">
                  <div class="card bg-info text-white">
                    <div class="card-body">
                      <h5>Jumlah Siswa: <span id="student-count">0</span></h5>
                    </div>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="card bg-warning text-white">
                    <div class="card-body">
                      <h5>Jumlah Guru: <span id="teacher-count">0</span></h5>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Prediksi Cuaca</h3>
                    </div>
                    <div class="card-body">
                      <div id="weather-forecast" class="weather-forecast">
                        <p>Loading weather forecast...</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="mt-1 mb-1 rounded-full">
              <div class="content">
                <!-- Main Content -->
                <section class="content">
                  <div class="row">
                    <div class="col-lg-3 col-6">
                      <div class="small-box bg-info">
                        <div class="inner">
                          <h4>TEMP</h4>
                          <h3><span id="temp-value">--</span>°C</h3>
                        </div>
                        <div class="icon">
                          <i class="fas fa-thermometer-half"></i>
                        </div>
                      </div>
                    </div>

                    <div class="col-lg-3 col-6">
                      <div class="small-box bg-success">
                        <div class="inner">
                          <h4>HUM</h4>
                          <h3><span id="humidity-value">--</span>%</h3>
                        </div>
                        <div class="icon">
                          <i class="fas fa-water"></i>
                        </div>
                      </div>
                    </div>

                    <div class="col-lg-3 col-6">
                      <div class="small-box bg-warning">
                        <div class="inner">
                          <h4>ALT</h4>
                          <h3><span id="altitude-value">--</span> m</h3>
                        </div>
                        <div class="icon">
                          <i class="fas fa-mountain"></i>
                        </div>
                      </div>
                    </div>

                    <div class="col-lg-3 col-6">
                      <div class="small-box bg-danger">
                        <div class="inner">
                          <h4>PRESS</h4>
                          <h3><span id="pressure-value">--</span> hPa</h3>
                        </div>
                        <div class="icon">
                          <i class="fas fa-tachometer-alt"></i>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-12">
                      <div class="card">
                        <div class="card-header">
                          <h3 class="card-title">Temperature and Humidity</h3>
                        </div>
                        <div class="card-body">
                          <canvas id="lineChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <!-- Terrace Lamp Toggle -->
                  <div class="col-md-3 col-12">
                    <p class="mr-2">STOP KONTAK :</p>
                    <div class="custom-control custom-switch">
                      <button
                        type="button"
                        name="button-settings"
                        id="Hijau1"
                        class="btn btn-danger"
                        value="on1"
                        onClick="changeStatus(this.value)"
                      >
                        OFF
                      </button>
                      <button
                        type="button"
                        name="button-settings"
                        id="Merah1"
                        class="btn btn-success"
                        value="off1"
                        onClick="changeStatus(this.value)"
                      >
                        ON
                      </button>
                    </div>
                  </div>

                  <!-- Garden Lamp Toggle -->
                  <div class="col-md-3 col-12">
                    <p class="mr-2">GARDEN LAMP :</p>
                    <div class="custom-control custom-switch">
                      <button
                        type="button"
                        name="button-settings"
                        id="Hijau2"
                        class="btn btn-danger"
                        value="on2"
                        onClick="changeStatus(this.value)"
                      >
                        OFF
                      </button>
                      <button
                        type="button"
                        name="button-settings"
                        id="Merah2"
                        class="btn btn-success"
                        value="off2"
                        onClick="changeStatus(this.value)"
                      >
                        ON
                      </button>
                    </div>
                  </div>

                  <!-- Room Lamp Toggle -->
                  <div class="col-md-3 col-12">
                    <p class="mr-2">LAMPU MERAH :</p>
                    <div class="custom-control custom-switch">
                      <button
                        type="button"
                        name="button-settings"
                        id="Hijau3"
                        class="btn btn-success"
                        value="on3"
                        onClick="changeStatus(this.value)"
                      >
                        ON
                      </button>
                      <button
                        type="button"
                        name="button-settings"
                        id="Merah3"
                        class="btn btn-danger"
                        value="off3"
                        onClick="changeStatus(this.value)"
                      >
                        OFF
                      </button>
                    </div>
                  </div>

                  <!-- Alarm Lamp Toggle -->
                  <div class="col-md-3 col-12">
                    <p class="mr-2">BUZZER :</p>
                    <div class="custom-control custom-switch">
                      <button
                        type="button"
                        name="button-settings"
                        id="Hijau4"
                        class="btn btn-success"
                        value="on4"
                        onClick="changeStatus(this.value)"
                      >
                        ON
                      </button>
                      <button
                        type="button"
                        name="button-settings"
                        id="Merah4"
                        class="btn btn-danger"
                        value="off4"
                        onClick="changeStatus(this.value)"
                      >
                        OFF
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="main-footer">
      <strong
        >Copyright © 2014-2021
        <a href="https://adminlte.io">AdminLTE.io</a>.</strong
      >
      All rights reserved.
      <div class="float-right d-none d-sm-inline-block">
        <b>Version</b> 3.2.0
      </div>
    </footer>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap 4 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- AdminLTE JS -->
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom JS -->
    <script>
      $(document).ready(function () {
        function updateSensorData() {
          $.ajax({
            url: "/updateData",
            method: "GET",
            success: function (data) {
              const parsedData = JSON.parse(data);

              $("#temp-value").text(parsedData.readingTemp.toFixed(1));
              $("#humidity-value").text(parsedData.readingHum.toFixed(1));
              $("#pressure-value").text(parsedData.readingPress.toFixed(1));
              $("#altitude-value").text(parsedData.readingAlt.toFixed(1));

              const co = parsedData.readingCO;
              $("#terrace-status").text(co > 100 ? "ON" : "OFF");
              $("#garden-status").text(co > 200 ? "ON" : "OFF");
              $("#room-status").text(co > 300 ? "ON" : "OFF");

              // $("#running-text").text(`${parsedData.running}`);

              $("#ip").text(`Device IP: ${parsedData.ip}`);
            },
            error: function () {
              console.log("Error fetching sensor data");
            },
          });
        }

        updateSensorData();

        setInterval(updateSensorData, 5000);

        function toggleLamp(lampId) {
          const lamp = $("#" + lampId);
          const status = lamp.prop("checked") ? "on" : "off";
          const lampNumber = lampId.replace("Lamp", "");
          const ws = new WebSocket("ws://" + window.location.hostname + "/ws");

          ws.onopen = function () {
            ws.send(`${status}${lampNumber}`);
          };

          ws.onmessage = function (event) {
            console.log("WebSocket response:", event.data);
          };
        }

        $("#terraceLamp").on("change", function () {
          toggleLamp("terraceLamp");
        });

        $("#gardenLamp").on("change", function () {
          toggleLamp("gardenLamp");
        });

        $("#roomLamp").on("change", function () {
          toggleLamp("roomLamp");
        });
      });

      var targetUrl = `ws://${location.host}/ws`;
      var websocket;
      const name = document.querySelector(".name");
      const button = document.querySelector("button");

      window.addEventListener("load", onLoad);
      function onLoad() {
        initializeSocket();
        setDefaultSpeed();
      }

      function initializeSocket() {
        console.log(
          "Opening WebSocket connection to ESP32 MicroPython Server..."
        );
        websocket = new WebSocket(targetUrl);
        websocket.onopen = onOpen;
        websocket.onclose = onClose;
        websocket.onmessage = onMessage;
      }
      function onOpen(event) {
        console.log("Starting connection to WebSocket server..");
      }
      function onClose(event) {
        console.log("Closing connection to server..");
        setTimeout(initializeSocket, 2000);
      }
      function onMessage(event) {
        console.log("WebSocket message received:", event);
      }

      function sendMessage(message) {
        websocket.send(message);
      }

      var buttonSettings = document.querySelectorAll(
        'button[type=button][name="button-settings"]'
      );
      buttonSettings.forEach((button) =>
        button.addEventListener("click", () => {
          var btn = button.value;
          console.log("Button Settings :: " + btn);
          sendMessage(btn);
        })
      );

      function setDefaultSpeed() {
        console.log("Setting default speed to normal..");
        let idM1 = document.getElementById("Merah1");
        let idG1 = document.getElementById("Hijau1");

        let idM2 = document.getElementById("Merah2");
        let idG2 = document.getElementById("Hijau2");

        let idM3 = document.getElementById("Merah3");
        let idG3 = document.getElementById("Hijau3");

        let idM4 = document.getElementById("Merah4");
        let idG4 = document.getElementById("Hijau4");
      }

      $(document).ready(function () {
        // Function to update sensor data
        function updateSensorData() {
          $.ajax({
            url: "/updateData",
            method: "GET",
            success: function (data) {
              const parsedData = JSON.parse(data);

              $("#temp-value").text(parsedData.readingTemp.toFixed(1));
              $("#humidity-value").text(parsedData.readingHum.toFixed(1));
              $("#pressure-value").text(parsedData.readingPress.toFixed(1));
              $("#altitude-value").text(parsedData.readingAlt.toFixed(1));

              $("#ip").text(`Device IP: ${parsedData.ip}`);

              lineChart.data.datasets[0].data.push(
                parsedData.readingTemp.toFixed(1)
              );
              lineChart.data.datasets[1].data.push(
                parsedData.readingHum.toFixed(1)
              );

              const currentTime = new Date().toLocaleTimeString();
              lineChart.data.labels.push(currentTime);

              if (lineChart.data.labels.length > 10) {
                lineChart.data.labels.shift();
                lineChart.data.datasets[0].data.shift();
                lineChart.data.datasets[1].data.shift();
              }

              lineChart.update();
            },
            error: function () {
              console.log("Error fetching sensor data");
            },
          });
        }

        setInterval(updateSensorData, 5000);

        var ctx = document.getElementById("lineChart").getContext("2d");
        var lineChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Temperature",
                backgroundColor: "rgba(60,141,188,0.9)",
                borderColor: "rgba(60,141,188,0.8)",
                pointRadius: false,
                pointColor: "#3b8bba",
                pointStrokeColor: "rgba(60,141,188,1)",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(60,141,188,1)",
                data: [],
              },
              {
                label: "Humidity",
                backgroundColor: "rgba(210, 214, 222, 1)",
                borderColor: "rgba(210, 214, 222, 1)",
                pointRadius: false,
                pointColor: "rgba(210, 214, 222, 1)",
                pointStrokeColor: "#c1c7d1",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(220,220,220,1)",
                data: [],
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            legend: {
              display: true,
            },
            scales: {
              xAxes: [
                {
                  gridLines: {
                    display: false,
                  },
                },
              ],
              yAxes: [
                {
                  gridLines: {
                    display: true,
                  },
                },
              ],
            },
          },
        });
      });
      $(document).ready(function () {
        const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=Wonosobo,ina&APPID=e3929ede1298bd2850c2b0842b652b48`;

        function fetchWeatherForecast() {
          $.ajax({
            url: apiUrl,
            method: "GET",
            success: function (data) {
              const temperature = data.main.temp.toFixed(1);
              const feelsLike = data.main.feels_like.toFixed(1);
              const humidity = data.main.humidity;
              const pressure = data.main.pressure;
              const windSpeed = data.wind.speed;
              const windDirection = data.wind.deg;
              const description = data.weather[0].description;
              const icon = data.weather[0].icon;

              const forecastHtml = `
                <div class="row">
                  <div class="col-md-6">
                    <h4>Cuaca di ${data.name}, ${data.sys.country}</h4>
                    <div class="weather-icon">
                      <img src="http://openweathermap.org/img/wn/${icon}.png" alt="${description}">
                    </div>
                    <p><strong>Suhu:</strong> ${temperature}°C</p>
                    <p><strong>Terasa Seperti:</strong> ${feelsLike}°C</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Kelembaban:</strong> ${humidity}%</p>
                    <p><strong>Tekanan:</strong> ${pressure} hPa</p>
                    <p><strong>Kecepatan Angin:</strong> ${windSpeed} m/s (${windDirection}°)</p>
                    <p><strong>Deskripsi:</strong> ${description}</p>
                  </div>
                </div>
              `;

              $("#weather-forecast").html(forecastHtml);
            },
            error: function () {
              $("#weather-forecast").text("Failed to load weather forecast.");
            },
          });
        }

        fetchWeatherForecast();
      });

      function updateDashboardData() {
        $.ajax({
          url: "https://server-gamma-ebon-90.vercel.app/api/school-info",
          method: "GET",
          dataType: "json",
          success: function (data) {
            if (data.length > 0) {
              // Mengambil data dari elemen pertama array
              const schoolData = data[0];
              $("#running-text").text(schoolData.running_text);
              $("#student-count").text(schoolData.jumlah_siswa);
              $("#teacher-count").text(schoolData.jumlah_guru);
            } else {
              // Jika tidak ada data, tampilkan pesan default
              $("#running-text").text("No data available");
              $("#student-count").text("0");
              $("#teacher-count").text("0");
            }
          },
          error: function (xhr, status, error) {
            console.error("Error fetching data:", error);
          },
        });
      }

      // Panggil fungsi setiap 5 detik
      setInterval(updateDashboardData, 5000);

      // Jalankan fungsi ketika halaman selesai dimuat
      $(document).ready(function () {
        updateDashboardData();
      });
    </script>
  </body>
</html>
